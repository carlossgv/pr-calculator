# FILE: .github/workflows/build-push-deploy.yml
name: Build & Push (API+WEB) + Deploy

on:
  push:
    branches: [main, staging]
    tags: ["v*.*.*"]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  IMAGE_NAME_API: ghcr.io/${{ github.repository }}-api
  IMAGE_NAME_WEB: ghcr.io/${{ github.repository }}-web

jobs:
  # =========================
  # TEMP: Tailscale SSH smoke test
  # Commented out build/deploy for quick connectivity verification.
  # =========================
  tailscale_ssh_test:
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Connect to Tailscale (Headscale)
        uses: tailscale/github-action@v4
        with:
          authkey: ${{ secrets.TS_AUTHKEY }}
          tags: tag:github-actions
          args: >
            --login-server=https://vpn.carlosgv.dev
            --accept-dns=false
            --timeout=45s
          ping: ${{ vars.DEPLOY_HOST_TS }}

      - name: Validate Tailscale auth key
        env:
          TS_AUTHKEY: ${{ secrets.TS_AUTHKEY }}
        run: |
          if [ -z "${TS_AUTHKEY:-}" ]; then
            echo "TS_AUTHKEY is missing. Add it under repo Settings → Secrets and variables → Actions." >&2
            exit 1
          fi

      - name: Tailscale SSH test
        run: |
          set -euo pipefail
          tailscale ssh ${{ vars.SERVER_USER }}@${{ vars.DEPLOY_HOST_TS }} 'whoami && hostname && date'
